'use client';

import { useState } from 'react';
import { useInterview } from '@/hooks/useInterview';
import { usePopup } from '@/hooks/usePopup';
import useRequest from '@/hooks/useRequest';
import { Button } from '@/components';
import css from './PromtGeneratorForm.module.scss';

const systemPrompt = `
–¢—ã –≤—ã—Å—Ç—É–ø–∞–µ—à—å –≤ —Ä–æ–ª–∏ HR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–Ω—Ç–µ—Ä–≤—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.  
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON ‚Äî **–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ**. –¢–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π JSON-–æ–±—ä–µ–∫—Ç.

–í–æ—Ç —Ñ–æ—Ä–º–∞—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

{
  "slug": "<–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ! (–∏—Å–ø–æ–ª—å–∑—É—è –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ 'name')>",
  "name": "<–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ! (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)>",
  "category": "<–ù–µ —Ç—Ä–æ–≥–∞—Ç—å, –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å!>",
  "description": "<–ó–∞–ø–æ–ª–Ω–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ! –∫—Ä–∞—Ç–∫–æ, –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤, –ø–æ —Ç–µ–º–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>",
  "thumbnail": "<–ù–µ —Ç—Ä–æ–≥–∞—Ç—å, –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å!>",
  "duration": <–ó–∞–ø–æ–ª–Ω–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ. –≠—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é –≤ –º–∏–Ω—É—Ç–∞—Ö. –≠—Ç—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ–∑—å–º–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20>,
  "difficulty": "<–ó–∞–ø–æ–ª–Ω–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ. –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: '–õ–µ–≥–∫–æ–µ', '–°—Ä–µ–¥–Ω–µ–µ', '–°–ª–æ–∂–Ω–æ–µ'. –û–ø—Ä–µ–¥–µ–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤>",
  "data": [
    // –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é. –¢—ã –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –µ–≥–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.
    {
      "id": "<–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª–∏–Ω–æ–π 24 —Å–∏–º–≤–æ–ª–∞ (–∫–∞–∫ –≤ MongoDB)>",
      "type": "question" | "message",
      "text": "<–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è>"
    },
    ...
  ]
}

üî∏ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ "data" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∞ —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –°–æ–∑–¥–∞–π –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É—è –∏–º–µ—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.  
üî∏ –í –º–∞—Å—Å–∏–≤–µ "data" —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –æ–¥–∏–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π "message".  
üî∏ –î–∞–ª–µ–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ª–æ–≥–∏—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "question", —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–≤—å—é.  
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ –Ω–µ—ë. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ä–∞—Å—Å—á–∏—Ç–∞–π –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ (–∏–Ω—Ç–µ—Ä–≤—å—é –Ω–∞ 20 –º–∏–Ω—É—Ç –æ–±—ã—á–Ω–æ –≤–∫–ª—é—á–∞–µ—Ç 5-7 –≤–æ–ø—Ä–æ—Å–æ–≤).  
üî∏ –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω—ã–º–∏ –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –∂–∏–≤–æ–º—É —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é.  
üî∏ –ó–∞–≤–µ—Ä—à–∏ –∏–Ω—Ç–µ—Ä–≤—å—é —Ñ–∏–Ω–∞–ª—å–Ω—ã–º "message", –≤ –∫–æ—Ç–æ—Ä–æ–º –±–ª–∞–≥–æ–¥–∞—Ä–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ.
`.trim();

const PromtGeneratorForm = () => {
  const [prompt, setPrompt] = useState('');
  const { interview, setInterview } = useInterview();
  const { openPopup, closePopup } = usePopup();

  const { trigger, isMutating } = useRequest({ url: '/api/generate-interview', method: 'POST' });

  const handleSubmit = async e => {
    e.preventDefault();

    openPopup({
      type: 'loading',
      locked: true,
      subtitle: '–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤—å—é –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É. –≠—Ç–æ –∑–∞–π–º—ë—Ç –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.',
    });

    const fullPrompt = `
      ${systemPrompt}
      –í–æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:
      ${JSON.stringify(interview, null, 2)}
      –í–æ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
      ${prompt}
    `.trim();

    const generated = await trigger({ prompt: fullPrompt });

    if (generated) {
      closePopup();
      setInterview(generated);
    }
  };

  return (
    <form className={css.PromtGeneratorForm} onSubmit={handleSubmit} noValidate>
      <span>
        –í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º ‚Äî –æ–Ω –¥–æ–±–∞–≤–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã. <br />
        –¢–∞–∫–∂–µ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –¥–∞–ª–µ–µ.
      </span>
      <label>
        <input
          type="text"
          name="prompt"
          placeholder="–î–ª—è –∫–∞–∫–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ —Ö–æ—Ç–µ–ª–∏ –±—ã –ø—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–≤—å—é?"
          onChange={e => setPrompt(e.target.value)}
          required
        />
      </label>
      <Button type="submit" disabled={isMutating}>
        –°–æ–∑–¥–∞—Ç—å
      </Button>
    </form>
  );
};

export default PromtGeneratorForm;
